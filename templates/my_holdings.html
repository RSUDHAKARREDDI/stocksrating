{% extends "layout.html" %}
{% block title %}Holdings Dashboard{% endblock %}

{% block content %}
<style>
  /* Scoped styles for this page only */
  .page-wrap {
    display: grid;
    grid-template-columns: 240px 1fr;
    gap: 16px;
    margin: 24px auto;
    width: min(1400px, 96vw);
  }

  .sidebar {
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,.06);
    border: 1px solid #e5e7eb;
    position: sticky;
    top: 12px; /* sticks under your header/menu */
    height: max-content;
  }
  .sidebar h3 {
    margin: 0;
    padding: 14px 14px 10px;
    font-size: 16px;
    color: #333;
    border-bottom: 1px solid #f0f2f5;
  }
  .side-list {
    list-style: none;
    margin: 0;
    padding: 8px;
  }
  .side-list li { margin: 4px 0; }
  .side-link {
    display: flex;
    justify-content: space-between; /* text left, optional badge/right icon */
    align-items: center;
    gap: 8px;
    padding: 10px 12px;
    border-radius: 10px;
    text-decoration: none;
    color: #333;
    border: 1px solid transparent;
  }
  .side-link:hover { background: #f6f7fb; border-color: #eef0f4; }
  .side-link.active { background: #eaf3ff; border-color: #cfe6ff; color: #0b63c0; font-weight: 600; }

  .main {
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,.06);
    border: 1px solid #e5e7eb;
    padding: 18px;
  }

  .kpis {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 16px;
  }
  .kpi {
    background: #f9fbff;
    border: 1px solid #eef2ff;
    border-radius: 12px;
    padding: 12px;
  }
  .kpi .label { font-size: 12px; color: #6b7280; }
  .kpi .value { font-size: 18px; font-weight: 700; margin-top: 4px; }

  .table-wrap { overflow: auto; border: 1px solid #eef0f4; border-radius: 10px; }
  table { width: 100%; min-width: 900px; border-collapse: collapse; }
  thead th {
    background: #f6f7fb;
    color: #6b7280;
    text-align: left;
    font-size: 12px;
    padding: 10px;
    border-bottom: 1px solid #eaecef;
  }
  tbody td { padding: 10px; border-bottom: 1px solid #f0f2f5; }
  tbody tr:hover { background: #fcfdff; }

  /* Responsive: sidebar collapses on small screens */
  @media (max-width: 900px) {
    .page-wrap { grid-template-columns: 1fr; }
    .sidebar { position: static; }
  }
</style>

<div class="page-wrap">
  <!-- LEFT SIDEBAR -->
  <aside class="sidebar">
    <h3>üìä Portfolio</h3>
    <ul class="side-list">
      <li><a class="side-link {% if request.path == '/holdings' %}active{% endif %}" href="/holdings">Holdings</a></li>
      <li><a class="side-link {% if request.path.startswith('/baskets') %}active{% endif %}" href="/baskets">Baskets</a></li>
      <li><a class="side-link {% if request.path.startswith('/transactions') %}active{% endif %}" href="/transactions">Transactions</a></li>
      <li><a class="side-link {% if request.path == '/holdings/sector' %}active{% endif %}" href="/holdings/sector">Sector Allocation</a></li>
      <li><a class="side-link {% if request.path == '/holdings/kpis' %}active{% endif %}" href="/holdings/kpis">KPIs</a></li>
    </ul>

    <h3>‚öôÔ∏è Admin</h3>
    <ul class="side-list">
      <li><a class="side-link {% if request.path == '/upload-files' %}active{% endif %}" href="/upload-files">Upload Files</a></li>
      <li><a class="side-link {% if request.path == '/data-load' %}active{% endif %}" href="/data-load">Data Load</a></li>
      <li><a class="side-link {% if request.path == '/screeners' %}active{% endif %}" href="/screeners">Screeners</a></li>
      <li><a class="side-link {% if request.path == '/latest-results' %}active{% endif %}" href="/latest-results">Latest Results</a></li>
    </ul>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main">
    <h2 style="margin:0 0 8px;">Holdings Dashboard</h2>
    <div style="color:#6b7280; margin-bottom:14px;">
      Live summary of your equity holdings. Filter/Sort features can be added next.
    </div>

    <!-- KPI CARDS (sample placeholders‚Äîbind to vw_portfolio_kpis in Flask) -->
    <div class="kpis">
      <div class="kpi">
        <div class="label">Total Invested</div>
        <div class="value">{{ kpis.total_invested if kpis else '‚Äî' }}</div>
      </div>
      <div class="kpi">
        <div class="label">Current Value</div>
        <div class="value">{{ kpis.total_current if kpis else '‚Äî' }}</div>
      </div>
      <div class="kpi">
        <div class="label">Net P&L</div>
        <div class="value">{{ kpis.net_pnl_value if kpis else '‚Äî' }} ({{ kpis.net_pnl_pct if kpis else '‚Äî' }}%)</div>
      </div>
      <div class="kpi">
        <div class="label">Today's P&L</div>
        <div class="value">{{ kpis.day_pnl if kpis else '‚Äî' }}</div>
      </div>
    </div>

    <!-- HOLDINGS TABLE (bind to vw_positions_with_ltp) -->
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Exchange</th>
            <th>Symbol</th>
            <th>Company</th>
            <th class="right">Qty</th>
            <th class="right">Avg Price</th>
            <th class="right">LTP</th>
            <th class="right">Invested</th>
            <th class="right">Current</th>
            <th class="right">P&L</th>
            <th class="right">P&L %</th>
            <th class="right">Day P&L</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
          <tr>
            <td>{{ r.exchange }}</td>
            <td><a href="/symbol/{{ r.symbol_id }}">{{ r.symbol }}</a></td>
            <td>{{ r.company_name }}</td>
            <td class="right">{{ r.net_qty }}</td>
            <td class="right">{{ '%.2f'|format(r.avg_price or 0) }}</td>
            <td class="right">{{ '%.2f'|format(r.ltp or 0) }}</td>
            <td class="right">{{ '%.2f'|format(r.invested_value or 0) }}</td>
            <td class="right">{{ '%.2f'|format(r.current_value or 0) }}</td>
            <td class="right" style="color: {{ 'green' if (r.pnl_value or 0) >= 0 else 'red' }};">
              {{ '%.2f'|format(r.pnl_value or 0) }}
            </td>
            <td class="right" style="color: {{ 'green' if (r.pnl_pct or 0) >= 0 else 'red' }};">
              {{ '%.2f'|format(r.pnl_pct or 0) }}%
            </td>
            <td class="right" style="color: {{ 'green' if (r.day_pnl or 0) >= 0 else 'red' }};">
              {{ r.day_pnl is not none and ('%.2f'|format(r.day_pnl)) or '‚Äî' }}
            </td>
          </tr>
          {% else %}
          <tr><td colspan="11" style="text-align:center;color:#6b7280;">No holdings found</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </main>
</div>
{% endblock %}
