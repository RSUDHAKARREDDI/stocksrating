{% extends "layout.html" %}
{% block title %}Holdings Dashboard{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/my_holdings.css') }}">
<style>
  /* small per-page spacing so imported css remains authoritative */
  .controls { margin-bottom: 12px; }
</style>

<div class="page-wrap">
  <!-- LEFT SIDEBAR (keeps your original sidebar items) -->
  <aside class="sidebar">
    <h3>üìä Portfolio</h3>
    <ul class="side-list">
      <li><a class="side-link {% if request.path == '/holdings' %}active{% endif %}" href="/holdings">Holdings</a></li>
      <li><a class="side-link {% if request.path.startswith('/baskets') %}active{% endif %}" href="/baskets">Baskets</a></li>
      <li><a class="side-link {% if request.path.startswith('/transactions') %}active{% endif %}" href="/transactions">Transactions</a></li>
      <li><a class="side-link {% if request.path == '/holdings/sector' %}active{% endif %}" href="/holdings/sector">Sector Allocation</a></li>
      <li><a class="side-link {% if request.path == '/holdings/kpis' %}active{% endif %}" href="/holdings/kpis">KPIs</a></li>
    </ul>

    <h3>‚öôÔ∏è Admin</h3>
    <ul class="side-list">
      <li><a class="side-link {% if request.path == '/upload-files' %}active{% endif %}" href="/upload-files">Upload Files</a></li>
      <li><a class="side-link {% if request.path == '/data-load' %}active{% endif %}" href="/data-load">Data Load</a></li>
      <li><a class="side-link {% if request.path == '/screeners' %}active{% endif %}" href="/screeners">Screeners</a></li>
      <li><a class="side-link {% if request.path == '/latest-results' %}active{% endif %}" href="/latest-results">Latest Results</a></li>
    </ul>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main">
    <h2 style="margin:0 0 8px;">Holdings Dashboard</h2>
    <div style="color:#6b7280; margin-bottom:14px;">
      Live summary of your equity holdings. Use filters to view Open / Closed positions.
    </div>

    <!-- CONTROLS: search, basket, basket id, position, load prices -->
    <div class="controls">
      <label for="filterCompany">Company</label>
      <input id="filterCompany" type="text" placeholder="search company">

      <label for="filterBasket">Basket</label>
      <select id="filterBasket">
        <option value="">All</option>
        <!-- JS will populate extra options based on table data -->
      </select>

      <label for="filterBasketId">Basket ID</label>
      <input id="filterBasketId" type="text" placeholder="basket id">

      <label for="filterPosition">Position</label>
      <select id="filterPosition">
        <option value="both">Both</option>
        <option value="open">Open</option>
        <option value="closed">Closed</option>
      </select>

      <button id="btn_load_prices" class="btn live" style="margin-left:8px;">Load Prices</button>
    </div>

    <!-- SUMMARY CARDS (IDs used by the JS) -->
    <div class="summary-cards">
      <div class="summary-card">
        <div class="label">Rows</div>
        <div id="card_total" class="value">0</div>
      </div>
      <div class="summary-card">
        <div class="label">Companies</div>
        <div id="card_companies" class="value">0</div>
      </div>
      <div class="summary-card">
        <div class="label">Total Invested (Remaining)</div>
        <div id="card_invested" class="value">‚Çπ0.00</div>
      </div>
      <div class="summary-card">
        <div class="label">Current Value</div>
        <div id="card_current" class="value">‚Çπ0.00</div>
      </div>
      <div class="summary-card">
        <div class="label">Unrealised</div>
        <div id="card_unrealised" class="value muted">‚Çπ0.00</div>
      </div>
      <div class="summary-card">
        <div class="label">Sold Value</div>
        <div id="card_sell" class="value">‚Çπ0.00</div>
      </div>
      <div class="summary-card">
        <div class="label">Realised P&L</div>
        <div id="card_realised" class="value muted">‚Çπ0.00</div>
      </div>
    </div>

    <!-- HOLDINGS TABLE (table id expected by JS: holdingsTable) -->
    <div class="table-wrap">
      <table id="holdingsTable">
        <thead>
          <tr>
            <th>Exchange</th>
            <th>Symbol</th>
            <th>Company</th>
            <th class="right">Buy Qty</th>
            <th class="right">Sell Qty</th>
            <th class="right">Avg Buy Price</th>
            <th class="right">LTP</th>
            <th class="right">Invested</th>
            <th class="right">Current</th>
            <th class="right">Unrealised</th>
            <th class="right">Actions</th>
          </tr>
        </thead>
        <tbody>
          {# Render rows from your view 'rows' variable. Each <tr> MUST expose required data-* attributes #}
          {% for r in rows %}
          <tr
              data-holding_id="{{ r.holding_id }}"
              data-company="{{ r.company_name | default('') }}"
              data-basket="{{ r.basket | default('') }}"
              data-basket_id="{{ r.basket_id | default('') }}"
              data-buy_qty="{{ r.buy_qty | default(0) }}"
              data-sell_qty="{{ r.sell_qty | default(0) }}"
              data-buy_price="{{ ('%.6f'|format(r.avg_price or 0)) }}"
              data-sell_value="{{ ('%.6f'|format(r.sell_value or 0)) }}"
              data-instrument="{{ r.symbol | default('') }}"
          >
            <td>{{ r.exchange }}</td>
            <td><a href="/symbol/{{ r.symbol_id }}">{{ r.symbol }}</a></td>
            <td>{{ r.company_name }}</td>
            <td class="right">{{ r.buy_qty }}</td>
            <td class="right">{{ r.sell_qty }}</td>
            <td class="right">{{ '%.2f'|format(r.avg_price or 0) }}</td>

            <!-- LTP cell: has id used by JS lp-<holding_id> -->
            <td class="right" id="lp-{{ r.holding_id }}">{{ '%.2f'|format(r.ltp or 0) }}</td>

            <!-- Current value and unrealised (JS will update these elements after fetching live prices) -->
            <td class="right" id="cv-{{ r.holding_id }}">{{ '%.2f'|format(r.current_value or 0) }}</td>
            <td class="right" id="ug-{{ r.holding_id }}">{{ '%.2f'|format(r.unrealised or 0) }}</td>

            <td class="actions-cell">
              <a class="btn" href="/holdings/{{ r.holding_id }}">Details</a>
              <a class="btn" href="/transactions/new?symbol={{ r.symbol }}">Trade</a>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="11" style="text-align:center;color:#6b7280;">No holdings found</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </main>
</div>

<!-- include your js (ensure path matches your project) -->
<script src="{{ url_for('static', filename='js/my_holdings.js') }}"></script>
{% endblock %}
