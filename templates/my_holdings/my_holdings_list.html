{% extends "layout.html" %}
{% block title %}My Holdings{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/my_holdings.css') }}">
<script defer src="{{ url_for('static', filename='js/my_holdings.js') }}"></script>

<div class="page-wrap">
  <aside class="left-menu">
    <h3 class="menu-title">Holdings Menu</h3>
    <a href="{{ url_for('my_holdings_bp.my_holdings_list') }}">All Holdings</a>
    <a href="{{ url_for('my_holdings_bp.my_holdings_create') }}">Add Holding</a>
  </aside>

  <section class="content">
    <div class="content-head">
      <h2>My Holdings</h2>
      <div class="actions">
        <!-- Add record -->
        <a class="btn primary" href="{{ url_for('my_holdings_bp.my_holdings_create') }}" title="Add holding">‚ûï</a>
        <!-- On-demand live prices -->

      </div>
    </div>

    {# ===== Summary totals (sold-only P/L) ===== #}
    {% set ns = namespace(rows=0, companies=[], invested=0.0, sell=0.0, invested_sold=0.0) %}
    {% for r in rows %}
      {% set bq = (r.Buy_Qty or 0) | float %}
      {% set bp = (r.Buy_Price or 0) | float %}
      {% set sq = (r.Sell_Qty or 0) | float %}
      {% set sp = (r.Sell_Price or 0) | float %}

      {% set ns.rows = ns.rows + 1 %}
      {% set ns.invested = ns.invested + (bq * bp) %}

      {% if sq > 0 %}
        {% set ns.sell = ns.sell + (sq * sp) %}
        {% set ns.invested_sold = ns.invested_sold + (sq * bp) %}
      {% endif %}

      {% if r.Company_Name not in ns.companies %}
        {% set _ = ns.companies.append(r.Company_Name) %}
      {% endif %}
    {% endfor %}
    {% set netpl = ns.sell - ns.invested_sold %}
    {% set pl_class = 'pos' if netpl>0 else ('neg' if netpl<0 else 'muted') %}

    <div class="summary-cards">
      <div class="summary-card">
        <div class="label">Total Holdings</div>
        <div class="value">{{ ns.rows }}</div>
      </div>
      <div class="summary-card">
        <div class="label">Unique Companies</div>
        <div class="value">{{ ns.companies|length }}</div>
      </div>
      <div class="summary-card">
        <div class="label">Total Invested</div>
        <div class="value">‚Çπ{{ '%.2f'|format(ns.invested) }}</div>
      </div>
      <div class="summary-card">
        <div class="label">Total Sell Value</div>
        <div class="value">‚Çπ{{ '%.2f'|format(ns.sell) }}</div>
      </div>
      <div class="summary-card">
        <div class="label">Net P/L (Sold Only)</div>
        <div class="value {{ pl_class }}">‚Çπ{{ '%.2f'|format(netpl) }}</div>
      </div>
    </div>

    <div class="controls">
      <label for="filterCompany">Company</label>
      <input id="filterCompany" type="text" placeholder="Type to filter by company‚Ä¶">

      <label for="filterBasket">Basket</label>
      <select id="filterBasket">
        <option value="">All</option>
      </select>

      <label for="filterBasketId">Basket ID</label>
      <input id="filterBasketId" type="text" placeholder="e.g. 1, 12, 205‚Ä¶" inputmode="numeric">
    </div>

    <div class="table-wrap">
      <table id="holdingsTable">
        <thead>
          <tr>
            <th class="sortable" data-key="company" data-type="text">Company <span class="arrow"></span></th>
            <th class="num">Live&nbsp;Price&nbsp;<button id="btn_load_prices" class="btn live" type="button" title="Fetch live prices (on demand)">üîÑ</button></th>
            <th class="num">Buy&nbsp;Qty</th>
            <th class="num">Buy&nbsp;Price</th>
            <th class="num sortable" data-key="invested" data-type="num">Invested <span class="arrow"></span></th>
            <th class="num">Sell&nbsp;Qty</th>
            <th class="num">Sell&nbsp;Price</th>
            <th class="num sortable" data-key="sell_value" data-type="num">Sell&nbsp;Value <span class="arrow"></span></th>
            <th class="num sortable" data-key="profit" data-type="num">Profit <span class="arrow"></span></th>
            <th class="sortable" data-key="basket" data-type="text">Basket <span class="arrow"></span></th>
            <th class="num sortable" data-key="tscore" data-type="num">Total Score <span class="arrow"></span></th>
            <th class="muted">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
          {% set bq = (r.Buy_Qty or 0) | float %}
          {% set bp = (r.Buy_Price or 0) | float %}
          {% set invested = bq * bp %}
          {% set sq = (r.Sell_Qty or 0) | float %}
          {% set sp = (r.Sell_Price or 0) | float %}
          {% set has_sell = sq > 0 %}
          {% set sell_value = (sq * sp) if has_sell else None %}
          {% set profit = (sq * (sp - bp)) if has_sell else None %}
          {% set basket_id = r.Basket_ID or '-' %}
          {% set tscore = r['Total Score'] or '-' %}
          {% set profit_class = ('pos' if profit and profit>0 else ('neg' if profit and profit<0 else 'muted')) %}
          <tr
            data-company="{{ r.Company_Name|e }}"
            data-buy_qty="{{ bq|int }}"
            data-buy_price="{{ bp|round(6) }}"
            data-invested="{{ invested|round(6) }}"
            data-sell_qty="{{ sq|int }}"
            data-sell_price="{{ sp|round(6) }}"
            data-sell_value="{{ (sell_value|round(6)) if has_sell else '' }}"
            data-profit="{{ (profit|round(6)) if has_sell else '' }}"
            data-basket="{{ basket_id }}"
            data-basket_id="{{ basket_id }}"
            data-holding_id="{{ r.holding_id }}"
          >
            <td>{{ r.Company_Name }}</td>
            <td class="num"><span id="lp-{{ r.holding_id }}">‚Äî</span></td>
            <td class="num">{{ bq|int }}</td>
            <td class="num">{{ bp|round(2) }}</td>
            <td class="num">{{ invested|round(2) }}</td>
            <td class="num">{{ sq|int }}</td>
            <td class="num">{{ sp|round(2) }}</td>
            <td class="num">{{ '-' if not has_sell else (sell_value|round(2)) }}</td>
            <td class="num {{ profit_class }}">{{ '-' if not has_sell else (profit|round(2)) }}</td>
            <td><span class="chip">{{ basket_id }}</span></td>
            <td><span class="num">{{ tscore }}</span></td>
            <td>
              <a class="btn primary" href="{{ url_for('my_holdings_bp.my_holdings_sell', holding_id=r.holding_id) }}" title="Sell">üí∞</a>
              <a class="btn" href="{{ url_for('my_holdings_bp.my_holdings_edit', holding_id=r.holding_id) }}" title="Edit">‚úèÔ∏è</a>
              <form method="post" action="{{ url_for('my_holdings_bp.my_holdings_delete', holding_id=r.holding_id) }}" class="inline-delete"
                    onsubmit="return confirm('Delete this record?');">
                <button type="submit" class="btn danger" title="Delete">üóëÔ∏è</button>
              </form>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="11">No records.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
</div>
{% endblock %}
