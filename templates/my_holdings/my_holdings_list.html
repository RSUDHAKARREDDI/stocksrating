{% extends "layout.html" %}
{% block title %}My Holdings{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/my_holdings.css') }}">
<script defer src="{{ url_for('static', filename='js/my_holdings.js') }}"></script>

  <section class="content">
    <div class="content-head">
      <h2>My Holdings</h2>
      <div class="actions">
        <a class="btn primary" href="{{ url_for('my_holdings_bp.my_holdings_create') }}" title="Add holding">‚ûï</a>
      </div>
    </div>

    {# ===== Summary totals (sold-only P/L + live-current stats) ===== #}
    {% set ns = namespace(rows=0, companies=[], invested_remaining=0.0, sell=0.0, invested_sold=0.0) %}
{% for r in rows %}
  {% set bq = (r.Buy_Qty or 0) | float %}
  {% set bp = (r.Buy_Price or 0) | float %}
  {% set sq = (r.Sell_Qty or 0) | float %}
  {% set sp = (r.Sell_Price or 0) | float %}
  {% set remaining = [bq - sq, 0] | max %}

  {% set ns.rows = ns.rows + 1 %}
  {% set ns.invested_remaining = ns.invested_remaining + (remaining * bp) %}

  {% if sq > 0 %}
    {% set ns.sell = ns.sell + (sq * sp) %}
    {% set ns.invested_sold = ns.invested_sold + (sq * bp) %}
  {% endif %}

  {% if r.Company_Name not in ns.companies %}
    {% set _ = ns.companies.append(r.Company_Name) %}
  {% endif %}
{% endfor %}
{% set realised = ns.sell - ns.invested_sold %}
{% set realised_class = 'pos' if realised>0 else ('neg' if realised<0 else 'muted') %}

    <div class="summary-cards">
      <div class="summary-card"><div class="label">Total Holdings</div><div id="card_total" class="value">{{ ns.rows }}</div></div>
      <div class="summary-card"><div class="label">Unique Companies</div><div id="card_companies" class="value">{{ ns.companies|length }}</div></div>
      <div class="summary-card"><div class="label">Total Invested</div><div id="card_invested" class="value">‚Çπ{{ '%.2f'|format(ns.invested_remaining) }}</div></div>

      <!-- New cards (live-calculated in JS after price refresh) -->
      <div class="summary-card"><div class="label">Current Value</div><div id="card_current" class="value">‚Çπ0.00</div></div>
      <div class="summary-card"><div class="label">Unrealised P/L</div><div id="card_unrealised" class="value muted">‚Çπ0.00</div></div>

      <div class="summary-card"><div class="label">Total Sell Value</div><div id="card_sell" class="value">‚Çπ{{ '%.2f'|format(ns.sell) }}</div></div>
      <div class="summary-card"><div class="label">Realised P/L (Net Profit)</div><div id="card_realised" class="value {{ realised_class }}">‚Çπ{{ '%.2f'|format(realised) }}</div></div>
    </div>

    <div class="controls">
      <label for="filterCompany">Company</label>
      <input id="filterCompany" type="text" placeholder="Type to filter by company‚Ä¶">

      <label for="filterBasket">Basket</label>
      <select id="filterBasket">
        <option value="">All</option>
      </select>

      <label for="filterBasketId">Basket ID</label>
      <input id="filterBasketId" type="text" placeholder="e.g. 1, 12, 205‚Ä¶" inputmode="numeric">

      <!-- NEW: Position filter -->
      <label for="filterPosition">Position</label>
      <select id="filterPosition">
        <option value="both">Both</option>
        <option value="open">Open</option>
        <option value="closed">Closed</option>
      </select>
    </div>

    <div class="table-wrap">
      <table id="holdingsTable">
        <thead>
          <tr>
            <th class="sortable" data-key="company" data-type="text">Company <span class="arrow"></span></th>

            <th class="num">
              Live&nbsp;Price
              <button id="btn_load_prices" class="btn live" type="button" title="Fetch live prices (on demand)">üîÑ</button>
            </th>

            <th class="num">Buy&nbsp;Qty</th>
            <th class="num">Buy&nbsp;Price</th>

            <!-- NEW: Avg Buy Price column (sortable) -->
            <th class="num sortable" data-key="avg_buy_price" data-type="num">Avg&nbsp;Buy&nbsp;Price <span class="arrow"></span></th>

            <th class="num sortable" data-key="invested" data-type="num">Invested <span class="arrow"></span></th>

            <!-- NEW: Current Value & Unrealised P/L -->
            <th class="num sortable" data-key="current_value" data-type="num">Current&nbsp;Value <span class="arrow"></span></th>
            <th class="num sortable" data-key="unrealised" data-type="num">Unrealised&nbsp;P/L <span class="arrow"></span></th>

            <th class="num">Sell&nbsp;Qty</th>
            <th class="num">Sell&nbsp;Price</th>
            <th class="num sortable" data-key="sell_value" data-type="num">Sell&nbsp;Value <span class="arrow"></span></th>
            <th class="num sortable" data-key="profit" data-type="num">Profit <span class="arrow"></span></th>

            <th class="sortable" data-key="basket" data-type="text">Basket <span class="arrow"></span></th>
            <th class="num sortable" data-key="tscore" data-type="num">Total Score <span class="arrow"></span></th>
            <th class="num sortable" data-key="delvrypct" data-type="num">Delivery % <span class="arrow"></span></th>
            <th class="num sortable" data-key="series" data-type="text">Series<span class="arrow"></span></th>
            <th class="num" data-key="52wkhigh" data-type="num">52 WK High <span class="arrow"></span></th>
            <th class="num" data-key="52wklow" data-type="num">52 WK Low <span class="arrow"></span></th>

            <!-- NEW: Position column a -->
            <th>Position</th>

            <th class="muted">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
          {# compute basic values #}
          {% set bq = (r.Buy_Qty or 0) | float %}
          {% set bp = (r.Buy_Price or 0) | float %}
          {% set invested = bq * bp %}
          {% set sq = (r.Sell_Qty or 0) | float %}
          {% set sp = (r.Sell_Price or 0) | float %}
          {% set has_sell = sq > 0 %}
          {% set sell_value = (sq * sp) if has_sell else None %}
          {% set profit = (sq * (sp - bp)) if has_sell else None %}
          {% set basket_id = r.Basket_ID or '-' %}
          {% set tscore = r['Total Score'] or '-' %}
          {% set delvrypct = r['DELIV_PER'] or '-' %}
          {% set series = r['SERIES'] or '-' %}
          {% set wk52_high = r['52_Week_High'] %}
          {% set wk52_low  = r['52_Week_Low'] %}
          {% set profit_class = ('pos' if profit and profit>0 else ('neg' if profit and profit<0 else 'muted')) %}

          {# remaining qty and invested_remaining for current/unrealised calc #}
          {% set remaining_qty = ([ (r.Buy_Qty or 0) - (r.Sell_Qty or 0), 0 ] | max) %}
          {% set invested_remaining = remaining_qty * bp %}

          {# prefer server-provided buy_avg_price (from your SQL), otherwise fallback to per-row buy price #}
          {% if r.buy_avg_price is defined and r.buy_avg_price is not none %}
            {% set avg_stock_level = (r.buy_avg_price)|float %}
          {% else %}
            {% set avg_stock_level = bp %}
          {% endif %}

          <tr
            data-company="{{ r.Company_Name|e }}"
            data-buy_qty="{{ bq|int }}"
            data-buy_price="{{ bp|round(6) }}"
            data-avg_buy_price="{{ avg_stock_level|round(6) }}"
            data-invested="{{ invested|round(6) }}"

            data-current_value=""          {# filled after live price #}
            data-unrealised=""             {# filled after live price #}

            data-sell_qty="{{ sq|int }}"
            data-sell_price="{{ sp|round(6) }}"
            data-sell_value="{{ (sell_value|round(6)) if has_sell else '' }}"
            data-profit="{{ (profit|round(6)) if has_sell else '' }}"
            data-basket="{{ basket_id }}"
            data-basket_id="{{ basket_id }}"
            data-holding_id="{{ r.holding_id }}"

            data-invested_remaining="{{ invested_remaining|round(6) }}"
          >
            <td>{{ r.Company_Name }}</td>

            <td class="num"><span id="lp-{{ r.holding_id }}">‚Äî</span></td>

            <td class="num">{{ bq|int }}</td>
            <td class="num">{{ bp|round(2) }}</td>

            <!-- NEW cell: Avg Buy Price (server-provided) -->
            <td class="num"><span id="avg-{{ r.holding_id }}">{{ avg_stock_level|round(2) }}</span></td>

            <td class="num">{{ invested|round(2) }}</td>

            <!-- NEW cells: populated after price refresh -->
            <td class="num"><span id="cv-{{ r.holding_id }}">‚Äî</span></td>
            <td class="num"><span id="ug-{{ r.holding_id }}" class="muted">‚Äî</span></td>

            <td class="num">{{ sq|int }}</td>
            <td class="num">{{ sp|round(2) }}</td>
            <td class="num">{{ '-' if not has_sell else (sell_value|round(2)) }}</td>
            <td class="num {{ profit_class }}">{{ '-' if not has_sell else (profit|round(2)) }}</td>

            <td><span class="chip">{{ r.Basket_ID or '-' }}</span></td>
            <td><span class="num">{{ tscore }}</span></td>
            <td><span class="num">{{ delvrypct|round(2)}}</span></td>
            <td><span class="num">{{ series }}</span></td>
            <td><span class="num">{{ wk52_high|round(2)}}</span></td>
            <td><span class="num">{{ wk52_low|round(2)}}</span></td>


            <!-- Position badge (server-side initial render) -->
            <td><span class="chip position-chip {% if sq>0 %}closed{% else %}open{% endif %}">{{ 'Closed' if sq>0 else 'Open' }}</span></td>

<td class="actions-cell">
  <a class="btn primary" href="{{ url_for('my_holdings_bp.my_holdings_sell', holding_id=r.holding_id) }}" title="Sell">üí∞</a>
  <a class="btn" href="{{ url_for('my_holdings_bp.my_holdings_edit', holding_id=r.holding_id) }}" title="Edit">‚úèÔ∏è</a>
  <form method="post" action="{{ url_for('my_holdings_bp.my_holdings_delete', holding_id=r.holding_id) }}" class="inline-delete"
        onsubmit="return confirm('Delete this record?');">
    <button type="submit" class="btn danger" title="Delete">üóëÔ∏è</button>
  </form>
</td>
          </tr>
          {% else %}
          <tr><td colspan="17">No records.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
</div>
{% endblock %}
