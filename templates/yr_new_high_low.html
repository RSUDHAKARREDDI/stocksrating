{% extends "layout.html" %}
{% block title %}52 Week High/Low Analysis{% endblock %}

{% block content %}
<div class="container" style="margin-top: 20px; font-family: 'Segoe UI', sans-serif; max-width: 1200px; margin-left: auto; margin-right: auto;">
    <h2 style="margin-bottom: 20px; color: #333;">52 Week High / Low Report</h2>

    <div style="background:#fff; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,.06); padding:20px; overflow-x: auto;">
        <table id="reportTable" style="width: 100%; border-collapse: collapse; text-align: left; font-size: 14px;">
            <thead>
                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6; cursor: pointer;">
                    <th onclick="sortTable(0, 'string')" style="padding: 12px;">Symbol ↕</th>
                    <th onclick="sortTable(1, 'string')" style="padding: 12px;">Date ↕</th>
                    <th onclick="sortTable(2, 'number')" style="padding: 12px;">Current Price ↕</th>
                    <th onclick="sortTable(3, 'number')" style="padding: 12px;">52W High ↕</th>
                    <th onclick="sortTable(4, 'number')" style="padding: 12px; color: #007bff; background: #eef6ff;">Dist. High % ↕</th>
                    <th onclick="sortTable(5, 'number')" style="padding: 12px;">52W Low ↕</th>
                    <th onclick="sortTable(6, 'number')" style="padding: 12px; color: #007bff; background: #eef6ff;">Dist. Low % ↕</th>
                </tr>
            </thead>
            <tbody>
                {% for row in rows %}
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 12px; font-weight: bold;">{{ row.SYMBOL }}</td>
                    <td style="padding: 12px;">{{ row.DATE1_STR }}</td>
                    <td style="padding: 12px;" data-value="{{ row.LAST_PRICE }}">{{ row.LAST_PRICE }}</td>
                    <td style="padding: 12px; color: #28a745;" data-value="{{ row.Adjusted_52_Week_High }}">{{ row.Adjusted_52_Week_High }}</td>
                    <td style="padding: 12px; color: #dc3545; font-weight: bold;" data-value="{{ row.pct_from_high }}">
                        {{ row.pct_from_high }}%
                    </td>
                    <td style="padding: 12px; color: #dc3545;" data-value="{{ row.Adjusted_52_Week_Low }}">{{ row.Adjusted_52_Week_Low }}</td>
                    <td style="padding: 12px; color: #28a745; font-weight: bold;" data-value="{{ row.pct_from_low }}">
                        +{{ row.pct_from_low }}%
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
/**
 * Efficient Array-based Table Sort
 * @param {number} colIndex - Index of the column
 * @param {string} type - 'number' or 'string'
 */
function sortTable(colIndex, type) {
    const table = document.getElementById("reportTable");
    const tbody = table.querySelector("tbody");
    const rows = Array.from(tbody.querySelectorAll("tr"));

    // Check current sort direction (stored on the table element)
    const currentDir = table.getAttribute("data-sort-dir") === "asc" ? "desc" : "asc";
    table.setAttribute("data-sort-dir", currentDir);

    const sortedRows = rows.sort((a, b) => {
        const aCell = a.cells[colIndex];
        const bCell = b.cells[colIndex];

        // Get value from data-value attribute, or fallback to textContent
        let aVal = aCell.getAttribute("data-value") || aCell.textContent.trim();
        let bVal = bCell.getAttribute("data-value") || bCell.textContent.trim();

        if (type === 'number') {
            return currentDir === "asc"
                ? parseFloat(aVal) - parseFloat(bVal)
                : parseFloat(bVal) - parseFloat(aVal);
        } else {
            return currentDir === "asc"
                ? aVal.localeCompare(bVal)
                : bVal.localeCompare(aVal);
        }
    });

    // Remove existing rows and append sorted rows
    while (tbody.firstChild) {
        tbody.removeChild(tbody.firstChild);
    }
    tbody.append(...sortedRows);
}
</script>
{% endblock %}