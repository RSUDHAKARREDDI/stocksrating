{% extends "layout.html" %}
{% block title %}52 Week High/Low Cards{% endblock %}

{% block content %}
<div class="container" style="margin-top: 20px; font-family: 'Segoe UI', sans-serif; max-width: 1400px; margin-left: auto; margin-right: auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="color: #333;">Market Watch: 52W High/Low</h2>
        <select id="sortSelect" onchange="sortCards()" style="padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
            <option value="symbol">Sort by Symbol</option>
            <option value="high">Sort by % from High</option>
            <option value="low">Sort by % from Low</option>
        </select>
    </div>

    <div id="cardGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px;">
        {% for row in rows %}
        <div class="stock-card"
             data-symbol="{{ row.SYMBOL }}"
             data-high="{{ row.pct_from_high }}"
             data-low="{{ row.pct_from_low }}"
             style="background: #fff; border-radius: 10px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 1px solid #eee;">

            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span style="font-weight: 800; color: #1a73e8; font-size: 1.1rem;">{{ row.SYMBOL }}</span>
                <span style="font-size: 0.75rem; color: #888;">{{ row.SERIES or 'EQ' }}</span>
            </div>

            <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 15px;">
                â‚¹{{ row.LAST_PRICE }}
            </div>

            <div style="margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: #666; margin-bottom: 4px;">
                    <span>L: {{ row.Adjusted_52_Week_Low }}</span>
                    <span>H: {{ row.Adjusted_52_Week_High }}</span>
                </div>
                <div style="height: 6px; background: #e0e0e0; border-radius: 3px; position: relative;">
                    {% set range = row.Adjusted_52_Week_High|float - row.Adjusted_52_Week_Low|float %}
                    {% set pos = ((row.LAST_PRICE|float - row.Adjusted_52_Week_Low|float) / range * 100) if range > 0 else 0 %}
                    <div style="position: absolute; left: {{ pos }}%; top: 50%; transform: translate(-50%, -50%); width: 12px; height: 12px; background: #1a73e8; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                </div>
            </div>

            <div style="display: flex; justify-content: space-between; font-size: 0.8rem;">
                <div style="color: #dc3545;">
                    <small>From High</small><br>
                    <strong>{{ row.pct_from_high }}%</strong>
                </div>
                <div style="color: #28a745; text-align: right;">
                    <small>From Low</small><br>
                    <strong>+{{ row.pct_from_low }}%</strong>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<style>
    /* Ensure exactly 5 columns on large screens */
    @media (min-width: 1200px) {
        #cardGrid {
            grid-template-columns: repeat(5, 1fr) !important;
        }
    }
    .stock-card:hover {
        transform: translateY(-3px);
        transition: all 0.2s ease;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1) !important;
    }
</style>

<script>
function sortCards() {
    const grid = document.getElementById("cardGrid");
    const cards = Array.from(grid.getElementsByClassName("stock-card"));
    const sortBy = document.getElementById("sortSelect").value;

    cards.sort((a, b) => {
        if (sortBy === 'symbol') {
            return a.dataset.symbol.localeCompare(b.dataset.symbol);
        } else if (sortBy === 'high') {
            return parseFloat(a.dataset.high) - parseFloat(b.dataset.high);
        } else if (sortBy === 'low') {
            return parseFloat(b.dataset.low) - parseFloat(a.dataset.low);
        }
    });

    // Re-append to grid
    grid.innerHTML = "";
    cards.forEach(card => grid.appendChild(card));
}
</script>
{% endblock %}