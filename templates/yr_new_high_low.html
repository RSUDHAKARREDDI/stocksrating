{% extends "layout.html" %}
{% block content %}
<div class="container" style="margin-top: 20px; font-family: 'Segoe UI', sans-serif; max-width: 1400px; margin-left: auto; margin-right: auto;">

    <div style="display: flex; gap: 12px; margin-bottom: 20px; background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #ddd; align-items: center; flex-wrap: wrap;">

        <select id="sortSelect" onchange="applyFilters()" style="padding: 6px; border-radius: 4px; border: 1px solid #ccc;">
            <option value="symbol">Sort: Symbol</option>
            <option value="score">Sort: Total Score</option>
            <option value="low">Sort: Near Low</option>
            <option value="high">Sort: Near High</option>
        </select>

        <select id="capFilter" onchange="applyFilters()" style="padding: 6px; border-radius: 4px; border: 1px solid #ccc;">
            <option value="all">All Market Caps</option>
            <option value="LARGE CAP">Large Cap</option>
            <option value="MID CAP">Mid Cap</option>
            <option value="SMALL CAP">Small Cap</option>
            <option value="MICRO CAP">Micro Cap</option>
        </select>

        <select id="seriesFilter" onchange="applyFilters()" style="padding: 6px; border-radius: 4px; border: 1px solid #ccc;">
            <option value="all">All Series</option>
            <option value="EQ">EQ</option>
            <option value="BE">BE</option>
            <option value="SM">SM</option>
        </select>

        <button onclick="resetFilters()" style="padding: 6px 15px; background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s;">
            Reset Filters
        </button>
    </div>

    <div id="cardGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 15px;">
        {% for row in rows %}
        <div class="stock-card"
             data-symbol="{{ row.SYMBOL }}"
             data-score="{{ row.total_score }}"
             data-high="{{ row.pct_from_high }}"
             data-low="{{ row.pct_from_low }}"
             data-cap="{{ row.market_cap_cat }}"
             data-series="{{ row.series_val }}"
             style="background: #fff; border-radius: 12px; padding: 18px; border: 1px solid #e0e0e0; box-shadow: 0 4px 6px rgba(0,0,0,0.04);">

            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <h3 style="margin: 0; color: #1a73e8; font-size: 1.1em;">{{ row.SYMBOL }}</h3>
                    <span style="font-size: 0.7em; background: #e8f0fe; color: #1967d2; padding: 2px 5px; border-radius: 4px; font-weight: bold;">{{ row.series_val }}</span>
                </div>
                <div style="text-align: right;">
                    <div style="font-weight: bold;">Score: {{ row.total_score }}</div>
                    <small style="color: #5f6368; font-size: 0.75em;">{{ row.market_cap_cat }}</small>
                </div>
            </div>

            <div style="margin: 18px 0 8px 0;">
                <div style="height: 4px; background: #f1f3f4; border-radius: 2px; position: relative;">
                    <div style="position: absolute; left: 0; height: 100%; width: {{ row.range_pos }}%; background: linear-gradient(to right, #ea4335, #fbbc04, #34a853); border-radius: 2px;"></div>
                    <div style="position: absolute; left: {{ row.range_pos }}%; top: -5px; height: 14px; width: 3px; background: #202124; border-radius: 1px; transform: translateX(-50%); border: 1px solid #fff;"></div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.65em; color: #80868b; margin-top: 4px;">
                    <span>52W L</span>
                    <span>52W H</span>
                </div>
            </div>

            <div style="display: flex; justify-content: space-between; font-size: 0.85em; margin-bottom: 12px; font-weight: 600;">
                <span style="color: {{ '#d93025' if row.pct_from_high > -0.5 else '#5f6368' }};">{{ row.pct_from_high }}%</span>
                <span style="color: {{ '#1e8e3e' if row.pct_from_low < 0.5 else '#5f6368' }};">+{{ row.pct_from_low }}%</span>
            </div>

            <div style="border-top: 1px solid #f1f3f4; padding-top: 10px; font-size: 0.8em; color: #3c4043;">
                <div style="display: flex; justify-content: space-between;">
                    <span>Essentials:</span> <strong>{{ row.mc_essentials }}</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>Technicals:</span> <strong>{{ row.mc_technicals }}</strong>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
function applyFilters() {
    const grid = document.getElementById("cardGrid");
    const cards = Array.from(grid.getElementsByClassName("stock-card"));

    const sortBy = document.getElementById("sortSelect").value;
    const capVal = document.getElementById("capFilter").value;
    const seriesVal = document.getElementById("seriesFilter").value;

    cards.forEach(card => {
        const capMatch = (capVal === "all" || card.dataset.cap === capVal);
        const seriesMatch = (seriesVal === "all" || card.dataset.series === seriesVal);
        card.style.display = (capMatch && seriesMatch) ? "block" : "none";
    });

    cards.sort((a, b) => {
        if (sortBy === 'symbol') return a.dataset.symbol.localeCompare(b.dataset.symbol);
        if (sortBy === 'score') return parseFloat(b.dataset.score) - parseFloat(a.dataset.score);
        if (sortBy === 'high') return parseFloat(a.dataset.high) - parseFloat(b.dataset.high);
        if (sortBy === 'low') return parseFloat(b.dataset.low) - parseFloat(a.dataset.low);
        return 0;
    });

    cards.forEach(card => grid.appendChild(card));
}

// Reset Function
function resetFilters() {
    document.getElementById("sortSelect").value = "symbol";
    document.getElementById("capFilter").value = "all";
    document.getElementById("seriesFilter").value = "all";
    applyFilters(); // Re-apply the default filters
}
</script>
{% endblock %}